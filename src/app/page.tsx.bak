'use client';

import { useMemo, useState, useEffect } from 'react';
import styles from './page.module.css';
import App from '@/utils/App';
import { IdentityManager, IdentityData } from '@/utils/identity';
import { QRCodeSVG } from 'qrcode.react';
import { Html5QrcodeScanner } from 'html5-qrcode';
import { simpleHash } from '@/utils/simpleHash';

export default function Home() {
  const app = useMemo(() => new App(), []);

  // App State
  // mode: 'home' | 'issuer' | 'holder' | 'verifier'
  const [mode, setMode] = useState<'home' | 'issuer' | 'holder' | 'verifier'>(
    'home',
  );

  // Issuer State
  const [issuerKey, setIssuerKey] = useState<string>('');
  const [issuerPk, setIssuerPk] = useState<string>('');
  const [issueData, setIssueData] = useState<IdentityData>({
    name: 'Alice',
    age: 25,
    residency: 'USA',
    photo: '',
  });
  const [mintedPod, setMintedPod] = useState<string>('');

  // Holder State
  const [myPod, setMyPod] = useState<string>(''); // Serialized POD
  const [myIssuerPk, setMyIssuerPk] = useState<string>('');
  const [holderStatus, setHolderStatus] = useState<string>('Idle');
  const [isScanning, setIsScanning] = useState(false);

  // Verifier State
  const [verifierStatus, setVerifierStatus] = useState<string>('Idle');
  const [receivedPod, setReceivedPod] = useState<any>(null);
  const [receivedIssuerPk, setReceivedIssuerPk] = useState<string>('');
  const [verificationResult, setVerificationResult] = useState<boolean | null>(
    null,
  );
  // Trusted Issuers
  const [trustedIssuers, setTrustedIssuers] = useState<string[]>([]);
  const [newTrustedKey, setNewTrustedKey] = useState('');

  const [requestedFields, setRequestedFields] = useState<string[]>([
    'name',
    'age',
    'residency',
  ]); // Default all

  // Custom Verification Logic
  type Requirement = { op: '==' | '>=' | '<='; val: string };
  const [requirements, setRequirements] = useState<Record<string, Requirement>>(
    {},
  );
  const [requirementResults, setRequirementResults] = useState<
    Record<string, boolean>
  >({});

  // Holder State for Request
  const [pendingRequest, setPendingRequest] = useState<string[]>([]);
  // const [disclosedData, setDisclosedData] = useState<any>(null);

  // MPC / ZK State
  const [mpcRequest, setMpcRequest] = useState<{ minAge?: number; checkName?: boolean } | null>(null);
  const [zkResultAge, setZkResultAge] = useState<boolean | null>(null);
  const [zkResultName, setZkResultName] = useState<boolean | null>(null);
  const mpcProgress = app.progress.use();

  // Common Connection State
  const step = app.step.use();
  // const party = app.party.use();
  const joiningCode = app.joiningCode.use();
  const [spinner, setSpinner] = useState(false);

  // Send request when Verifier connects
  useEffect(() => {
    if (mode === 'verifier' && step === 3) {
      // 1. Send ZK Request if needed
      const ageReq = requirements['age'];
      if (ageReq && ageReq.val) {
        const minAge = Number(ageReq.val);
        setTimeout(() => {
          console.log("Sending MPC Request for Age");
          app.sendData({ type: 'MPC_REQUEST', minAge });
        }, 500);
      }

      // 2. Send POD Request for NON-conditional fields
      // If we have a condition on Age, we DO NOT want to ask for Age disclosure.
      const fieldsToRequest = requestedFields.filter(f => {
        const req = requirements[f];
        // If there is a requirement value, we assume ZK (for age) and don't request disclosure
        if (f === 'age' && req && req.val) return false;
        return true;
      });

      if (fieldsToRequest.length > 0) {
        setTimeout(() => {
          console.log("Sending POD Request", fieldsToRequest);
          app.sendData({ type: 'POD_REQUEST', fields: fieldsToRequest });
        }, 600);
      }
    }
  }, [mode, step, app, requestedFields, requirements]);

  useEffect(() => {
    // Auto-connect if code exists and ID is ready
    if (mode === 'holder' && step === 1 && joiningCode && myPod) {
      // Optional: Auto-connect or just Highlight
      // console.log("Auto-connecting with code:", joiningCode);
      // To avoid loops or issues, we'll just let the button be enabled and visible.
      // But users asked "I STILL GET ASKED". Maybe we should scroll to it or emphasize it.
    }
  }, [mode, step, joiningCode, myPod]);

  useEffect(() => {
    // Auto-detect link code
    if (typeof window !== 'undefined') {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      if (code) {
        setMode('holder');
        app.joiningCode.set(code);
      }
    }
  }, [app]);

  useEffect(() => {
    // Generate Issuer Key on load (mock setup)
    try {
      // PERSISTENCE 1: Check localStorage for existing Issuer Key
      const storedKey = localStorage.getItem('verifier_issuer_key');
      if (storedKey) {
        console.log("Loaded Issuer Key from Storage");
        setIssuerKey(storedKey);
        IdentityManager.getPublicKey(storedKey).then(setIssuerPk);
      } else {
        const key = IdentityManager.generateIssuerKey();
        setIssuerKey(key);
        IdentityManager.getPublicKey(key).then(setIssuerPk);
        localStorage.setItem('verifier_issuer_key', key);
      }
    } catch (e) {
      console.error("Failed to init crypto", e);
    }

    // Listen for data
    if (app && app.onData) {
      app.onData((data: any) => {
        if (data.type === 'POD_REQUEST') {
          setPendingRequest(data.fields);
        }
        if (data.type === 'POD_PRESENTATION') {
          // data.presentation is the ZK/Selective proof object
          setReceivedPod(data.presentation);
          setReceivedIssuerPk(data.issuerPk);
          setVerifierStatus('Received Proof. Verifying...');
        }
        if (data.type === 'MPC_REQUEST') {
          setMpcRequest({ minAge: Number(data.minAge), checkName: data.checkName });
        }
      });
    }
  }, [app]);
  useEffect(() => {
    if (isScanning && mode === 'holder' && !myPod) {
      const scanner = new Html5QrcodeScanner(
        'reader',
        { fps: 10, qrbox: { width: 250, height: 250 } },
        /* verbose= */ false,
      );

      scanner.render(
        decodedText => {
          console.log('Scanned:', decodedText);
          importID(decodedText);
          scanner.clear();
          setIsScanning(false);
        },
        _error => {
          // handle scan error
        },
      );

      return () => {
        try {
          scanner.clear();
        } catch (_e) { }
      };
    }
  }, [isScanning, mode, myPod]);

  // Issuer Actions
  const mintID = () => {
    const pod = IdentityManager.mintPOD(issuerKey, issueData);
    const serialized = IdentityManager.serializePOD(pod);
    // Bundle PK with it for demo ease
    const bundle = JSON.stringify({ pod: serialized, issuerPk });
    setMintedPod(bundle);
  };

  const downloadPodFile = () => {
    if (!mintedPod) return;
    const blob = new Blob([mintedPod], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'identity.pod';
    a.click();
    URL.revokeObjectURL(url);
  };

  // Holder Actions
  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      const text = e.target?.result as string;
      importID(text);
    };
    reader.readAsText(file);
  };

  const importID = (json: string) => {
    try {
      const parsed = JSON.parse(json);
      // Basic validation
      if (!parsed.pod || !parsed.issuerPk) throw new Error("Missing fields");
      setMyPod(parsed.pod);
      setMyIssuerPk(parsed.issuerPk);
      setHolderStatus('ID Imported');

      // PERSISTENCE 2: Save imported ID
      localStorage.setItem('my_pod_data', json);
    } catch (e) {
      alert('Invalid ID Format: ' + e);
    }
  };

  useEffect(() => {
    // PERSISTENCE 3: Load Holder Data on mount
    const cachedPod = localStorage.getItem('my_pod_data');
    if (cachedPod) {
      console.log("Restoring cached ID");
      importID(cachedPod);
    }
  }, []);

  useEffect(() => {
    // PERSISTENCE 4: Load Trusted Issuers
    try {
      const storedTrust = localStorage.getItem('trusted_issuers');
      if (storedTrust) setTrustedIssuers(JSON.parse(storedTrust));

      // Auto-add local issuer key for convenience (since we are likely the demo operator)
      const localKey = localStorage.getItem('verifier_issuer_key_pk');
      // Wait, we didn't save the PK separately before, only the pair? 
      // Let's check how we save issuer key.
    } catch (e) { }
  }, []);

  const addTrustedIssuer = () => {
    if (!newTrustedKey) return;
    if (!trustedIssuers.includes(newTrustedKey)) {
      const updated = [...trustedIssuers, newTrustedKey];
      setTrustedIssuers(updated);
      localStorage.setItem('trusted_issuers', JSON.stringify(updated));
    }
    setNewTrustedKey('');
  };

  const clearTrustedIssuers = () => {
    setTrustedIssuers([]);
    localStorage.removeItem('trusted_issuers');
  }

  const sendID = () => {
    if (!myPod) return;
    try {
      // Use Real ZK/Selective Disclosure Presentation
      // 1. Deserialize my POD
      const pod = IdentityManager.deserializePOD(myPod);

      // 2. Determine fields to reveal (from pending request or default)
      const fieldsToReveal =
        pendingRequest.length > 0
          ? pendingRequest
          : ['age', 'residency', 'name', 'photo'];
      console.log('Generating Proof for:', fieldsToReveal);

      // 3. Create Cryptographic Presentation
      const presentation = IdentityManager.createPresentation(pod, fieldsToReveal);

      app.sendData({
        type: 'POD_PRESENTATION',
        presentation: presentation, // Use new structure
        issuerPk: myIssuerPk
      });
      setHolderStatus('ID Proof Sent (Selectively Revealed)');
      setPendingRequest([]);
    } catch (e) {
      console.error("Failed to generate proof", e);
      alert("Proof generation failed!");
    }
  };

  const startZKAgeCheck = async () => {
    if (!mpcRequest || !myPod) return;
    try {
      setHolderStatus('Initializing Secure MPC...');
      const pod = IdentityManager.deserializePOD(myPod);

      // Extract attributes
      let myAge = 0;
      let myName = "";

      const ageVal = pod.content.getValue('age');
      if (ageVal) myAge = Number(ageVal.value);

      const nameVal = pod.content.getValue('name');
      if (nameVal) myName = String(nameVal.value);

      setHolderStatus('Running Zero-Knowledge Proof... (Please wait)');

      const inputs = {
        age: myAge,
        residency: 1, // Dummy
        nameHash: myName ? simpleHash(myName) : 0
      };

      const result = await app.runVerification(inputs); // Holder joins

      const passed = result.ageValid && result.nameValid; // Roughly speaking

      setHolderStatus(
        'ZK Proof Completed. Verifier has received the result.'
      );
      setMpcRequest(null);
    } catch (e) {
      console.error(e);
      setHolderStatus('MPC Failed: ' + String(e));
      setMpcRequest(null);
    }
  };

  const toggleRequest = (field: string) => {
    setRequestedFields(prev =>
      prev.includes(field) ? prev.filter(f => f !== field) : [...prev, field],
    );
  };

  // Verifier Actions
  const verifyID = () => {
    if (!receivedPod) return; // receivedPod now holds "presentation"
    try {
      // Use Real Crypto Verification
      const isValid = IdentityManager.verifyPresentation(
        receivedPod,
        receivedIssuerPk,
      );

      if (isValid) {
        // Trusted Issuer Check
        const isTrusted = trustedIssuers.includes(receivedIssuerPk);
        if (!isTrusted && trustedIssuers.length > 0) {
          alert(`WARNING: Valid Signature, but Issuer Key NOT in Trusted List.\nKey: ${receivedIssuerPk.substring(0, 10)}...`);
        }

        setVerificationResult(true);
        setVerifierStatus(
          isTrusted
            ? '‚úÖ Verified Trusted Issuer & Checking Conditions...'
            : '‚ö†Ô∏è Verified UNTRUSTED Issuer & Checking Conditions...'
        );

        // CHECK REQUIREMENTS
        const results: Record<string, boolean> = {};
        if (receivedPod.revealed) {
          Object.keys(receivedPod.revealed).forEach(key => {
            const rawVal = receivedPod.revealed[key].value.value; // Can be BigInt or string
            const req = requirements[key];
            if (!req || req.val === '') {
              results[key] = true; // No requirement = Pass
              return;
            }

            // Normalize values for comparison
            let actual: number | string = rawVal;
            let target: number | string = req.val;

            // Handle BigInts / Numbers
            if (typeof rawVal === 'bigint') {
              actual = Number(rawVal);
            } else if (typeof rawVal === 'number') {
              actual = rawVal;
            } else {
              actual = String(rawVal);
            }

            // Try to cast target to number if actual is number
            if (typeof actual === 'number' && !isNaN(Number(target))) {
              target = Number(target);
            }

            if (req.op === '==') results[key] = actual == target;
            if (req.op === '>=') results[key] = actual >= target;
            if (req.op === '<=') results[key] = actual <= target;
          });
        }
        setRequirementResults(results);
      } else {
        throw new Error('Signature or Proof Invalid');
      }
    } catch (e) {
      console.error(e);
      setVerificationResult(false);
      setVerifierStatus('Verification Failed: ' + (e as any).message);
    }
  };

  const verifyAgeZK = async (minAge: number, requiredName: string) => {
    try {
      setVerifierStatus('Initiating Zero-Knowledge Check...');
      setZkResultAge(null);
      setZkResultName(null);

      // 1. Notify Holder
      // We send 'checkName: true' if we are checking name, but we DO NOT send the value.
      await app.sendData({ type: 'MPC_REQUEST', minAge, checkName: !!requiredName });

      // 2. Start MPC
      setVerifierStatus(
        'Running Secure Multi-Party Computation... (waiting for user)',
      );
      const inputs = {
        minAge,
        requiredResidency: 0,
        requiredNameHash: requiredName ? simpleHash(requiredName) : 0
      };

      const result = await app.runVerification(inputs);

      setZkResultAge(result.ageValid);
      if (requiredName) setZkResultName(result.nameValid);

      setVerifierStatus(
        'ZK Proof Completed.'
      );
    } catch (e) {
      console.error(e);
      setVerifierStatus('ZK Error: ' + String(e));
    }
  };

  const renderHome = () => (
    <div className={styles.step}>
      <h2>Select Role</h2>
      <div className={styles.card}>
        <button onClick={() => setMode('issuer')} className={styles.button}>
          GOVERNMENT (Issuer)
        </button>
        <p>Mint new Digital IDs</p>
      </div>
      <div className={styles.card}>
        <button onClick={() => setMode('holder')} className={styles.button}>
          CITIZEN (Holder)
        </button>
        <p>Store and Present ID</p>
      </div>
      <div className={styles.card}>
        <button onClick={() => setMode('verifier')} className={styles.button}>
          SERVICE (Verifier)
        </button>
        <p>Verify Attributes</p>
      </div>

      <div style={{ marginTop: '50px', borderTop: '1px solid #ccc', paddingTop: '20px' }}>
        <p style={{ fontSize: '0.8em', color: '#888' }}>Debug Actions</p>
        <button
          className={styles.button}
          style={{ background: '#d32f2f', fontSize: '0.8em' }}
          onClick={() => {
            if (confirm("Are you sure? This will delete all keys and IDs.")) {
              localStorage.clear();
              window.location.reload();
            }
          }}
        >
          Reset All Data (Clear Storage)
        </button>
      </div>
    </div>
  );

  const renderIssuer = () => (
    <div className={styles.step}>
      <h3>
        <button onClick={() => setMode('home')} className={styles.back}>
          ‚Üê
        </button>{' '}
        Issuer Portal
      </h3>

      <div className={styles.card} style={{ background: '#e3f2fd', marginBottom: '15px' }}>
        <p style={{ margin: '0', fontSize: '0.9em' }}><strong>My Public Key (For Verifiers):</strong></p>
        <code style={{ display: 'block', wordBreak: 'break-all', fontSize: '0.7em', marginTop: '5px' }}>{issuerPk}</code>
        <button
          onClick={() => navigator.clipboard.writeText(issuerPk)}
          style={{ marginTop: '5px', fontSize: '0.7em', padding: '2px 5px' }}
        >
          Copy Key
        </button>
      </div>

      <div className={styles.form}>
        <label>
          Name:{' '}
          <input
            value={issueData.name}
            onChange={e => setIssueData({ ...issueData, name: e.target.value })}
            className={styles.input}
          />
        </label>
        <label>
          Age:{' '}
          <input
            type="number"
            value={issueData.age}
            onChange={e =>
              setIssueData({ ...issueData, age: Number(e.target.value) })
            }
            className={styles.input}
          />
        </label>
        <label>
          Residency:{' '}
          <input
            value={issueData.residency}
            onChange={e =>
              setIssueData({ ...issueData, residency: e.target.value })
            }
            className={styles.input}
          />
        </label>
        <label>
          Photo ID:
          <input
            type="file"
            accept="image/*"
            onChange={e => {
              const file = e.target.files?.[0];
              if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                  setIssueData({ ...issueData, photo: reader.result as string });
                };
                reader.readAsDataURL(file);
              }
            }}
            style={{ marginTop: '10px' }}
          />
        </label>
        {issueData.photo && (
          <img src={issueData.photo} alt="ID Photo" style={{ width: '100px', height: '100px', objectFit: 'cover', borderRadius: '50%', display: 'block', margin: '10px auto', border: '2px solid #333' }} />
        )}

        <button onClick={mintID} className={styles.button}>
          Mint Digital ID
        </button>
      </div>

      {mintedPod && (
        <div className={styles.result}>
          <p>ID Minted.</p>
          <div
            style={{
              background: 'white',
              padding: '10px',
              display: 'inline-block',
            }}
          >
            <QRCodeSVG value={mintedPod} size={256} />
          </div>
          <button
            className={styles.button}
            style={{ marginTop: '10px', background: '#4CAF50' }}
            onClick={() => {
              try {
                console.log('--- DEBUG: Verifying Minted POD Locally ---');
                const parsed = JSON.parse(mintedPod);
                const pod = IdentityManager.deserializePOD(parsed.pod);
                // Create a full presentation (reveal all)
                const pres = IdentityManager.createPresentation(pod, [
                  'name',
                  'age',
                  'residency',
                ]);
                console.log('Created Presentation:', pres);
                const valid = IdentityManager.verifyPresentation(
                  pres,
                  parsed.issuerPk,
                );
                alert(
                  valid
                    ? 'Local Verification PASSED'
                    : 'Local Verification FAILED (Check Console)',
                );
              } catch (e) {
                console.error(e);
                alert('Error Checking: ' + e);
              }
            }}
          >
            Debug: Verify Now
          </button>
          <p style={{ fontSize: '0.9em', marginTop: '10px' }}>
            User: Scan this to import ID
          </p>
          <button
            onClick={downloadPodFile}
            className={styles.button}
            style={{ background: '#666', fontSize: '0.8em', marginTop: '10px' }}
          >
            Download backup
          </button>
        </div>
      )}
    </div>
  );

  const renderHolder = () => (
    <div className={styles.step}>
      <h3>
        <button onClick={() => setMode('home')} className={styles.back}>
          ‚Üê
        </button>{' '}
        Citizen Wallet
      </h3>

      {!myPod ? (
        <div>
          <p>Import Digital Identity</p>
          <div className={styles.card}>
            {!isScanning ? (
              <button
                onClick={() => setIsScanning(true)}
                className={styles.button}
              >
                üì∑ Scan QR Code
              </button>
            ) : (
              <div id="reader" style={{ width: '100%' }}></div>
            )}
          </div>
          {isScanning && (
            <button
              onClick={() => setIsScanning(false)}
              className={styles.button}
              style={{ background: '#888' }}
            >
              Cancel Scan
            </button>
          )}

          <p style={{ fontSize: '0.9em', marginTop: '20px' }}>
            Or upload backup:
          </p>
          <input
            type="file"
            accept=".pod,.json"
            onChange={handleFileUpload}
            className={styles.input}
          />
        </div>
      ) : (
        <div>
          <div className={styles.card} style={{ background: '#e3f2fd' }}>
            <h4>My Digital ID</h4>
            {myPhoto && (
              <img src={String(myPhoto)} alt="My ID Photo" style={{ width: '80px', height: '80px', borderRadius: '50%', objectFit: 'cover', margin: '0 auto 10px', border: '2px solid #ccc', display: 'block' }} />
            )}
            <p>
              ID Loaded: <strong>{myPod ? 'Ready' : 'Empty'}</strong>
            </p>
          </div>

          {step === 1 && (
            <div className={styles.card}>
              <p>Join a Verifier Scssion to present ID</p>
              <input
                type="text"
                value={joiningCode}
                placeholder="Enter Session Code from Verifier"
                onChange={e => app.joiningCode.set(e.target.value)}
                className={styles.input}
              />
              <button
                onClick={async () => {
                  setSpinner(true);
                  app.step.set(2);
                  try {
                    await app.connect(joiningCode, 'bob');
                  } catch (e) {
                    console.error(e);
                    alert('Connection failed. Check code.');
                    app.step.set(1);
                  } finally {
                    setSpinner(false);
                  }
                }}
                className={styles.button}
                disabled={!joiningCode}
              >
                {spinner ? 'Connecting...' : 'Connect'}
              </button>
            </div>
          )}

          {step === 2 && <div>Connecting...</div>}

          {step === 3 && (
            <div>
              <p style={{ color: 'green' }}>Connected to Verifier!</p>

              {pendingRequest.length > 0 ? (
                <div className={styles.card} style={{ borderColor: '#ff9800' }}>
                  <p>
                    <strong>Verifier Request:</strong>
                  </p>
                  <ul style={{ textAlign: 'left' }}>
                    {pendingRequest.map(f => (
                      <li key={f}>{f}</li>
                    ))}
                  </ul>
                  <p>Do you want to disclose these attributes?</p>
                  <button onClick={sendID} className={styles.button}>
                    Approve & Share
                  </button>
                </div>
              ) : (
                <div>
                  {mpcRequest ? (
                    <div
                      className={styles.card}
                      style={{ borderColor: '#9c27b0' }}
                    >
                      <h4 style={{ color: '#9c27b0' }}>üîí Private ZK Check</h4>
                      {mpcRequest.minAge && (
                        <p>
                          Verifier wants to check if{' '}
                          <strong>Age &ge; {mpcRequest.minAge}</strong>
                        </p>
                      )}
                      {mpcRequest.checkName && (
                        <p>
                          Verifier wants to check if{' '}
                          <strong>Name == [Hidden Target Name]</strong>
                        </p>
                      )}                      <p style={{ fontSize: '0.9em' }}>
                        Using Zero-Knowledge Proof (MPC). <br />
                        They will <strong>NOT</strong> see your actual data.
                      </p>

                      {mpcProgress > 0 && mpcProgress < 1 ? (
                        <div style={{ margin: '10px 0' }}>
                          <div
                            style={{
                              height: '5px',
                              background: '#eee',
                              width: '100%',
                            }}
                          >
                            <div
                              style={{
                                height: '100%',
                                background: '#9c27b0',
                                width: `${mpcProgress * 100}%`,
                                transition: 'width 0.2s',
                              }}
                            ></div>
                          </div>
                          <p style={{ fontSize: '0.8em' }}>
                            Computing... {(mpcProgress * 100).toFixed(0)}%
                          </p>
                        </div>
                      ) : (
                        <button
                          onClick={startZKAgeCheck}
                          className={styles.button}
                          style={{ background: '#9c27b0' }}
                        >
                          Run Private Check
                        </button>
                      )}
                    </div>
                  ) : (
                    <>
                      <p>Waiting for request...</p>
                      {/* Fallback manual button */}
                      <button
                        onClick={sendID}
                        className={styles.button}
                        style={{ opacity: 0.5 }}
                      >
                        Force Share All
                      </button>
                    </>
                  )}
                </div>
              )}

              <p>{holderStatus}</p>
            </div>
          )}
        </div>
      )}
    </div>
  );

  const renderVerifier = () => (
    <div className={styles.step}>
      <h3>
        <button onClick={() => setMode('home')} className={styles.back}>
          ‚Üê
        </button>{' '}
        Service Verifier
      </h3>

      {step === 1 && (
        <>
          <div className={styles.card} style={{ borderColor: '#2196f3' }}>
            <h4>Trusted Issuers</h4>
            <div style={{ display: 'flex', gap: '5px' }}>
              <input
                value={newTrustedKey}
                onChange={e => setNewTrustedKey(e.target.value)}
                placeholder="Paste Issuer Public Key"
                className={styles.input}
                style={{ fontSize: '0.8em' }}
              />
              <button onClick={addTrustedIssuer} className={styles.button} style={{ width: 'auto', padding: '5px' }}>
                Add
              </button>
            </div>
            {trustedIssuers.length > 0 && (
              <ul style={{ textAlign: 'left', fontSize: '0.7em', color: '#555', wordBreak: 'break-all' }}>
                {trustedIssuers.map(k => <li key={k}>{k.substring(0, 15)}...</li>)}
              </ul>
            )}
            {trustedIssuers.length > 0 && (
              <button onClick={clearTrustedIssuers} style={{ color: 'red', background: 'none', border: 'none', cursor: 'pointer', fontSize: '0.7em' }}>
                Clear Trusted List
              </button>
            )}
          </div>

          <div className={styles.card}>
            <p>Request specific attributes:</p>
            <div
              style={{ textAlign: 'left', margin: '0 auto', maxWidth: '300px' }}
            >
              {['name', 'age', 'residency', 'photo'].map(f => (
                <div
                  key={f}
                  style={{ marginBottom: '8px', borderBottom: '1px solid #eee' }}
                >
                  <label style={{ display: 'block', fontWeight: 'bold' }}>
                    <input
                      type="checkbox"
                      checked={requestedFields.includes(f)}
                      onChange={() => toggleRequest(f)}
                    />{' '}
                    {f}
                  </label>
                  {requestedFields.includes(f) && (
                    <div
                      style={{
                        marginLeft: '25px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '5px',
                        marginBottom: '5px',
                      }}
                    >
                      <span style={{ fontSize: '0.8em' }}>Req:</span>
                      <select
                        style={{ fontSize: '0.8em' }}
                        value={requirements[f]?.op || '=='}
                        onChange={e =>
                          setRequirements(p => ({
                            ...p,
                            [f]: {
                              op: e.target.value as any,
                              val: p[f]?.val || '',
                            },
                          }))
                        }
                      >
                        <option value="==">==</option>
                        <option value=">=">{'>='}</option>
                        <option value="<=">{'<='}</option>
                      </select>
                      <input
                        style={{
                          fontSize: '0.8em',
                          width: '80px',
                          padding: '2px',
                        }}
                        placeholder="Value"
                        value={requirements[f]?.val || ''}
                        onChange={e =>
                          setRequirements(p => ({
                            ...p,
                            [f]: { op: p[f]?.op || '==', val: e.target.value },
                          }))
                        }
                      />
                    </div>
                  )}
                </div>
              ))}
            </div>
            <p>Start a verification session</p>
            <button onClick={() => app.host()} className={styles.button}>
              Create Session
            </button>
          </div>
        </>
      )}

      {step === 2 && (
        <div>
          <p>Share this link to verify identity:</p>
          <div
            className={styles.card}
            style={{
              padding: '15px',
              background: '#f5f5f5',
              wordBreak: 'break-all',
              userSelect: 'all',
              cursor: 'text',
            }}
          >
            {typeof window !== 'undefined'
              ? `${window.location.origin}?code=${joiningCode}`
              : joiningCode}
          </div>
          <p style={{ fontSize: '0.9em', color: '#666' }}>
            Or enter code manually: <strong>{joiningCode}</strong>
          </p>
          <p>Waiting for user...</p>
          {/* Send request as soon as user connects? No, wait for connection event. */}
        </div>
      )}

      {step === 3 && (
        <div>
          <p style={{ color: 'green' }}>User Connected.</p>
          <p>Waiting for ID presentation...</p>

          {receivedPod && (
            <div className={styles.card}>
              <h4>ID Received</h4>
              <button onClick={verifyID} className={styles.button}>
                Verify Signature
              </button>
            </div>
          )}

          {/* ZK Button - Always show if Age condition is set, regardless of POD receipt */}
          {(mpcRequest?.minAge || requirements['age']?.val || requirements['name']?.val) && (
            <div className={styles.card} style={{ borderColor: '#9c27b0' }}>
              <h4 style={{ color: '#9c27b0' }}>üîí Zero-Knowledge Check</h4>

              {requirements['age']?.val && (
                <p>Verify <strong>Age &ge; {requirements['age'].val}</strong></p>
              )}
              {requirements['name']?.val && (
                <p>Verify <strong>Name == {requirements['name'].val}</strong></p>
              )}

              <p style={{ fontSize: "0.8em" }}>without reveling strict values.</p>

              {mpcProgress > 0 && mpcProgress < 1 ? (
                <div style={{ margin: '10px 0' }}>
                  <div
                    style={{ height: '5px', background: '#eee', width: '100%' }}
                  >
                    <div
                      style={{
                        height: '100%',
                        background: '#9c27b0',
                        width: `${mpcProgress * 100}%`,
                        transition: 'width 0.2s',
                      }}
                    ></div>
                  </div>
                  <p style={{ fontSize: '0.8em' }}>
                    Computing... {(mpcProgress * 100).toFixed(0)}%
                  </p>
                </div>
              ) : (
                <button
                  onClick={() => verifyAgeZK(
                    Number(requirements['age']?.val || 0),
                    requirements['name']?.val || ''
                  )}
                  className={styles.button}
                  style={{ background: '#9c27b0' }}
                >
                  Verify Attributes (Private MPC)
                </button>
              )}
              {zkResultAge !== null && (
                <p
                  style={{
                    fontWeight: 'bold',
                    color: zkResultAge ? 'green' : 'red',
                    marginTop: '10px',
                  }}
                >
                  AGE Check: {zkResultAge ? 'PASSED ‚úÖ' : 'FAILED ‚ùå'}
                </p>
              )}
              {zkResultName !== null && (
                <p
                  style={{
                    fontWeight: 'bold',
                    color: zkResultName ? 'green' : 'red',
                    marginTop: '10px',
                  }}
                >
                  NAME Check: {zkResultName ? 'PASSED ‚úÖ' : 'FAILED ‚ùå'}
                </p>
              )}
            </div>
          )}

          {verificationResult !== null && (
            <div className={styles.result}>
              <div
                style={{
                  color: verificationResult ? 'green' : 'red',
                  fontWeight: 'bold',
                }}
              >
                {verificationResult ? '‚úÖ VALID SIGNATURE' : '‚ùå INVALID'}
              </div>

              {verificationResult && (
                <div
                  style={{
                    marginTop: '10px',
                    textAlign: 'left',
                    background: '#eee',
                    padding: '10px',
                    borderRadius: '5px',
                  }}
                >
                  <p>
                    <strong>Revealed Attributes:</strong>
                  </p>
                  {/* Simulating Selective Retrieval Display */}
                  {(() => {
                    if (!receivedPod || !receivedPod.revealed) return null;
                    const revealed = receivedPod.revealed;
                    return (
                      <ul style={{ listStyle: 'none', paddingLeft: 0 }}>
                        {Object.keys(revealed).map(key => {
                          const val = revealed[key].value;
                          const reqPassed = requirementResults[key];

                          if (key === 'photo') {
                            return (
                              <li key={key} style={{ marginBottom: '5px', padding: '5px', borderBottom: '1px solid #ccc', display: 'flex', alignItems: 'center' }}>
                                <span style={{ textTransform: 'capitalize', width: '80px', display: 'inline-block', fontWeight: 'bold' }}>Photo</span>
                                <img src={val.value.toString()} style={{ width: '100px', borderRadius: '5px', border: '2px solid green' }} />
                                <span style={{ fontSize: '0.8em', color: 'green', marginLeft: '10px' }}> ‚úÖ Verified</span>
                              </li>
                            );
                          }

                          // Only show requiremenet status if one was set
                          const hasReq =
                            requirements[key] && requirements[key].val !== '';

                          return (
                            <li
                              key={key}
                              style={{
                                marginBottom: '5px',
                                padding: '5px',
                                borderBottom: '1px solid #ccc',
                              }}
                            >
                              <div>
                                <span
                                  style={{
                                    textTransform: 'capitalize',
                                    width: '80px',
                                    display: 'inline-block',
                                  }}
                                >
                                  {key}
                                </span>
                                <strong>
                                  {hasReq ? (
                                    <span style={{ color: '#9c27b0', fontStyle: 'italic' }}>
                                      [Hidden]
                                    </span>
                                  ) : (
                                    val.value.toString()
                                  )}
                                </strong>
                                <span
                                  style={{
                                    fontSize: '0.8em',
                                    color: 'green',
                                    marginLeft: '5px',
                                  }}
                                >
                                  {' '}
                                  (Verified)
                                </span>
                              </div>
                              {hasReq && (
                                <div
                                  style={{
                                    fontSize: '0.9em',
                                    marginTop: '2px',
                                    color: reqPassed ? 'green' : 'red',
                                  }}
                                >
                                  Condition: {requirements[key]?.op}{' '}
                                  {requirements[key]?.val}
                                  <strong style={{ marginLeft: '10px' }}>
                                    {reqPassed ? '‚úÖ MET' : '‚ùå FAILED'}
                                  </strong>
                                </div>
                              )}
                            </li>
                          );
                        })}
                      </ul>
                    );
                  })()}
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );

  const myPhoto = useMemo(() => {
    if (!myPod) return null;
    try {
      const pod = IdentityManager.deserializePOD(myPod);
      // @ts-ignore
      const content = pod.content.getEntries ? pod.content.getEntries() : pod.content;
      return content.photo?.value; // string (Base64)
    } catch { return null; }
  }, [myPod]);

  return (
    <div className={styles.app}>
      <div className={styles.header}>POD Digital Identity</div>
      <div className={styles['step-container']}>
        {mode === 'home' && renderHome()}
        {mode === 'issuer' && renderIssuer()}
        {mode === 'holder' && renderHolder()}
        {mode === 'verifier' && renderVerifier()}
      </div>
    </div>
  );
}
